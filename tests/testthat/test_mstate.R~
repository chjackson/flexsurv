context("Multi-state modelling and prediction")

require(mstate)
# library(testthat); library(devtools); 
# load_all("../..")

bexp <- flexsurvreg(Surv(Tstart, Tstop, status) ~ trans, data=bosms3, dist="exp")
bexp2 <- flexsurvreg(Surv(time, status) ~ trans, data=bosms3, dist="exp") 
tmat <- rbind(c(NA,1,2),c(NA,NA,3),c(NA,NA,NA))

mexp <- msfit(bexp, t=seq(0,150,1), trans=tmat, tvar="trans")

bcox <- coxph(Surv(time, status) ~ strata(trans), data=bosms3)
mcox <- msfit(bcox, trans=tmat)

bwei <- flexsurvreg(Surv(time, status) ~ trans + shape(trans), data=bosms3, dist="weibull")
mwei <- msfit(bwei, t=seq(0,150,1), trans=tmat, tvar="trans")

bgg <- flexsurvreg(Surv(time, status) ~ trans + sigma(trans) + Q(trans), data=bosms3, dist="gengamma")
mgg <- msfit(bgg, t=seq(0,150,1), trans=tmat, tvar="trans")

## how to constrain to exponential for 1-2 trans:  first shape par=1
bweifix <- flexsurvreg(Surv(Tstart, Tstop, status) ~ trans + shape(trans), data=bosms3, dist="weibull", fixedpars=1)
mweifix <- msfit(bweifix, t=seq(0,150,1), trans=tmat, tvar="trans")

## Spline: ideally need different spline functions for each transition.
## TODO strata(trans) should do this at least
bspl <- flexsurvspline(Surv(time, status) ~ trans, data=bosms3, k=1)
# CIs to do for spline models
# mspl <- msfit(bspl, t=seq(0,150,1), trans=tmat, tvar="trans")

-2*logLik(bexp)
-2*logLik(bweifix)
-2*logLik(bwei)
-2*logLik(bgg)
-2*logLik(bspl)
## Weibull model probably good enough here.

plot(mcox)
for (i in 1:3){
    lines(mexp$Haz$time[mexp$Haz$trans==i], mexp$Haz$Haz[mexp$Haz$trans==i], type="s")
    lines(mwei$Haz$time[mwei$Haz$trans==i], mwei$Haz$Haz[mwei$Haz$trans==i], type="s", col="red")
    lines(mweifix$Haz$time[mweifix$Haz$trans==i], mweifix$Haz$Haz[mweifix$Haz$trans==i], type="s", col="blue")
    lines(mgg$Haz$time[mgg$Haz$trans==i], mgg$Haz$Haz[mgg$Haz$trans==i], type="s", col="purple")
}

## Plot transition probabilities
## (though not valid for these semi-Markov models)
pt <- probtrans(mcox, predt=0, direction="forward")
plot(pt, from=1, xlim=c(0,150),ylim=c(0,1))
pt <- probtrans(mwei, predt=0, direction="forward")
par(new=TRUE)
plot(pt, xlim=c(0,150),ylim=c(0,1), col=rep("blue",3))
pt <- probtrans(mgg, predt=0, direction="forward")
par(new=TRUE)
plot(pt, xlim=c(0,150),ylim=c(0,1), col=rep("purple",3))


## With covariates

bosms3$x <- rnorm(nrow(bosms3))
bosms3$x2 <- factor(sample(0:2, size=nrow(bosms3), replace=TRUE))
bexp2 <- flexsurvreg(Surv(time, status) ~ trans + x + x2, data=bosms3, dist="exp")

test_that("Errors in msfit",{
    expect_error(mexp2 <- msfit(bexp2, t=seq(0,150,10), trans=tmat), "\"tvar\" not supplied and variable .* not in model")
    expect_error(mexp2 <- msfit(bexp2, t=seq(0,150,10), trans=tmat, tvar="foo"), "variable .* not in model")
    expect_error(mexp2 <- msfit(bexp2, t=seq(0,150,10), trans=tmat, tvar="trans"), "Values of covariates .* not supplied")
    msfit(bexp2, t=seq(0,150,10), trans=tmat, tvar="trans", newdata=data.frame(x=c(0,1,2), x2=c(0,1,2))) #works
})
