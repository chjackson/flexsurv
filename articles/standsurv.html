<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="flexsurv">
<title>Calculating standardized survival measures in flexsurv • flexsurv</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calculating standardized survival measures in flexsurv">
<meta property="og:description" content="flexsurv">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">flexsurv</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/pdf.html">flexsurv PDF vignettes</a>
    <a class="dropdown-item" href="../articles/standsurv.html">Calculating standardized survival measures in flexsurv</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/flexsurv/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Calculating standardized survival measures in flexsurv</h1>
                        <h4 data-toc-skip class="author">Michael
Sweeting<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="mailto:mikesweeting79@gmail.com" class="email"&gt;mikesweeting79@gmail.com&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/flexsurv/blob/HEAD/vignettes/standsurv.Rmd" class="external-link"><code>vignettes/standsurv.Rmd</code></a></small>
      <div class="d-none name"><code>standsurv.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<div class="section level3">
<h3 id="standardized-survival-measures">Standardized survival measures<a class="anchor" aria-label="anchor" href="#standardized-survival-measures"></a>
</h3>
<p><code>standsurv</code> is a post-estimation command that takes a
<code>flexsurvreg</code> object and calculates standardized survival
measures. After fitting a parametric survival model in
<code>flexsurv</code> it is often useful to compute and visualise the
marginal (or standardized) survival. For example, suppose a survival
model is fitted adjusted for treatment group, age, and sex. A separate
predicted survival curve can be obtained for each individual based on
their covariate pattern or a prediction can be obtained by setting
covariates to their mean values (both can be obtained using
<code>summary.flexsurvreg</code>), but it may be more useful to obtain
the marginal survival for each treatment group. Regression
standardization achieves this by fitting a regression model including
the treatment group <span class="math inline">\(Z\)</span>, covariates
<span class="math inline">\(X\)</span> and possible interactions between
<span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span>. The standardized survival can be
estimated by obtaining predictions for every individual in the study
under each fixed treatment arm and averaging these individual-specific
estimates. The marginal survival over the distribution of covariates in
the study assuming all participants were assigned to arm <span class="math inline">\(Z=z\)</span> is: <span class="math display">\[\begin{equation}
S_s(t|Z=z) = E[S(t | Z=z, X)] = \frac{1}{N} \sum_{i=1}^{N} S(t | Z=z,
X=x_i)
\end{equation}\]</span> for covariate values (vectors) <span class="math inline">\(x_1,...,x_{N}\)</span>. Here standarization is
done over all <span class="math inline">\(N\)</span> patients in the
study and provides a counterfactual marginal estimate when setting <span class="math inline">\(Z=z\)</span>. The standardized survival is
therefore an estimate of the marginal survival if all study patients had
been assigned to group <span class="math inline">\(z\)</span>. Under
certain assumptions, differences in marginal survival provide estimates
of causal effects (<span class="citation">Syriopoulou, Rutherford, and
Lambert (2021)</span>) and certain estimands such as the average
treatment effect (ATE) can be targeted: <span class="math display">\[
ATE = S_s(t|Z=z_1) - S_s(t|Z=z_0)]\]</span> Alternatively, an average
treatment effect in the treated (ATET) estimand can be targeted by
averaging over only patients who were in the intervention treatment arm
<span class="math inline">\(Z=z_1\)</span>. Standardization estimates
can also be obtained for other target populations of interest. For
example it may be important to predict survival in an external
population with different characteristics to the study population.</p>
<p>The hazard function for the standardized survival can be obtained to
understand how the shape of the hazard changes over time. This provides
an estimate of the marginal hazard. It can be shown (<span class="citation">Rutherford et al. (2020)</span>, Appendix I) that the
hazard of the standardized survival can be calculated as <span class="math display">\[\begin{equation}
h_s(t|Z=z) = \frac{\sum_{i=1}^{N}
S(t|Z=z,X=x_i)h(t|Z=z,X=x_i)}{\sum_{i=1}^{N} S(t | Z=z, X=x_i)}
\end{equation}\]</span> This is a weighted average of the <span class="math inline">\(N\)</span> individual hazard functions, weighted
by the probability of survival at time <span class="math inline">\(t\)</span>. Patients who are unlikely to have
survived to <span class="math inline">\(t\)</span> will contribute less
weight to this hazard function.</p>
</div>
<div class="section level3">
<h3 id="calculating-marginal-expected-survival-and-hazard">Calculating marginal expected survival and hazard<a class="anchor" aria-label="anchor" href="#calculating-marginal-expected-survival-and-hazard"></a>
</h3>
<p>In economic evaluations parametric survival models are used to
extrapolate clinical trial data to estimate lifetime benefits. In this
context it is often useful to plot marginal ‘expected’ (general
population) survival alongside parametric models fitted and extrapolated
from trial data in order to aid interpretation and for a visual
comparison between the trial subjects and the population at large.
Displaying expected survival and hazard functions can aid understanding
of whether the assumed hazard and survival functions are credible (<span class="citation">Rutherford et al. (2020)</span>). Expected survival is
defined as the all-cause survival in a general population with the same
key characteristics as the study subjects. General population mortality
rates are often taken from national lifetables that are stratified by
age, sex, calendar year and occasionally other prognostic factors
(e.g. deprivation indices).</p>
<p>The Ederer or “exact” method for estimating expected survival assumes
subjects in the trial population are not censored before the end of a
stated follow-up time <span class="citation">(Ederer, Axtell, and Cutler
1961)</span>. The expected survival is then the survival we would expect
to see in an age-sex matched general population if all patients are
continuously followed-up. This is the approach used by
<code>standsurv</code> to calculate expected survival and is the “most
appropriate when doing forcasting, sample size calculations or other
predictions of the ‘future’ where censoring is not an issue” <span class="citation">(Therneau 1999)</span>.</p>
<p>Based on the exact method, the marginal expected survival using
background mortality rates is calculated using all <span class="math inline">\(N\)</span> patients in the trial at any time point
<span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[\begin{equation}
S^*(t) = \frac{1}{N} \sum_{i=1}^N S_i^*(t)
\end{equation}\]</span> where <span class="math inline">\(S_i^*(t)\)</span> is the expected survival for the
<span class="math inline">\(i\)</span>th subject at time <span class="math inline">\(t\)</span>. It follows that the marginal expected
hazard is a weighted average of the expected hazard rates: <span class="math display">\[\begin{equation}
h^*(t) = \frac{
\sum_{i=1}^N S_i^*(t) h_i^*(t)}{\sum_{i=1}^N S_i^*(t)}
\end{equation}\]</span></p>
<p>The expected survival for the <span class="math inline">\(i\)</span>th subject at follow-up time <span class="math inline">\(t\)</span> is calculated based on matching to the
general population hazard rates. If lifetables are utilised these often
provide mortality rates by sex (<span class="math inline">\(s\)</span>),
age (<span class="math inline">\(a\)</span>) and calendar year (<span class="math inline">\(y\)</span>), in yearly or 5-yearly categories. In
practice the expected survival at time <span class="math inline">\(t\)</span> for a given subject is calculated from
the cumulative hazard. At a given follow-up time <span class="math inline">\(t\)</span> this is the sum of <span class="math inline">\(h^*_{asy} \times \textrm{Number of days in state }
(a,s,y)\)</span> in the follow-up where <span class="math inline">\(h^*_{asy}\)</span> is the expected hazard for age
<span class="math inline">\(a\)</span>, sex <span class="math inline">\(s\)</span>, year <span class="math inline">\(y\)</span>. This requires follow-up time for each
individual in the study dataset to be split by multiple timescales
(e.g. age and year) into time epochs, which can be visualised as a Lexis
diagram. Each epoch can then be matched to a corresponding expected
mortality rate.</p>
</div>
<div class="section level3">
<h3 id="incorporation-of-background-mortality-into-survival-models">Incorporation of background mortality into survival models<a class="anchor" aria-label="anchor" href="#incorporation-of-background-mortality-into-survival-models"></a>
</h3>
<p>Incorporating background mortality into survival models directly is
recommended as it helps avoid extremely implausible projections (<span class="citation">Rutherford et al. (2020)</span>). This can be done
using an excess mortality / relative survival model where population
based ‘expected’ rates, often from life tables, are introduced to
explain background mortality. The concept behind these models is to
partition the all-cause mortality into excess mortality caused by the
disease of interest and that due to other causes. A parametric model can
then be applied to the isolated excess mortality. This may be
particularly useful when making long-term extrapolations as the pattern
of disease-specific mortality and other cause mortality are likely to be
very different over time. Alternatively, if cause of death information
is available and reliable, a separate cause-specific model can be fitted
to the disease-specific mortality and other cause mortality.</p>
<p>The all-cause mortality rate at time <span class="math inline">\(t\)</span> for individual <span class="math inline">\(i\)</span> can be partitioned into two constituent
parts: <span class="math display">\[\begin{equation} h_i(t) = h^*_i(t) +
\lambda_i(t) \end{equation}\]</span> where <span class="math inline">\(h_i(t)\)</span> is the all-cause mortality rate
(hazard), <span class="math inline">\(h^*_i(t)\)</span> is the expected
or background mortality rate and <span class="math inline">\(\lambda_i(t)\)</span> is the excess mortality
rate. Equivalently, the hazard rates can be transformed to the survival
scale which gives the all-cause survival at time <span class="math inline">\(t\)</span> as the product of the expected survival
and the relative survival: <span class="math display">\[\begin{equation}
S_i(t) = S^*_i(t) R_i(t) \end{equation}\]</span> The relative survival,
<span class="math inline">\(R_i(t)\)</span>, is therefore the ratio of
all-cause survival and the expected survival in the background
population. Typically, <span class="math inline">\(h_i^*(t)\)</span>
(and hence <span class="math inline">\(S_i^*(t)\)</span>) are obtained
from population lifetables. The expected mortality rates are assumed to
be fixed and known and a parametric model is then used to estimate the
relative survival (or equivalently excess hazard).</p>
</div>
</div>
<div class="section level2">
<h2 id="standsurv">
<code>standsurv</code><a class="anchor" aria-label="anchor" href="#standsurv"></a>
</h2>
<p><code>standsurv</code> is a post-estimation command that takes a
<code>flexsurv</code> regression and calculates standardized survival
measures and contrasts. Expected mortality rates and survival can also
be obtained. The main features of the command are that it enables the
calculation and plotting over any specified follow-up times of</p>
<ol style="list-style-type: decimal">
<li>Marginal survival, hazard and restricted mean survival time (RMST)
metrics</li>
<li>Marginal expected (population) survival and hazard functions matched
to the study population</li>
<li>Marginal all-cause survival and all-cause hazard after fitting
relative survival models</li>
<li>Contrasts in survival, hazard and RMST metrics (e.g. marginal hazard
ratio, differences in marginal RMST)</li>
<li>Confidence intervals and standard errors for all measures and
contrasts using either the delta method or bootstrapping</li>
</ol>
<p>Through a simple syntax the user can specify the groups that they
wish to calculate the marginal metrics. These groups can be formed by
any combination of covariate values.</p>
<div class="section level3">
<h3 id="a-worked-example-the-pbc-dataset">A worked example: the pbc dataset<a class="anchor" aria-label="anchor" href="#a-worked-example-the-pbc-dataset"></a>
</h3>
<p>For this example we will use data from the German Breast Cancer Study
Group 1984-1989, which is the R dataset <code>bc</code> found in the
<code>flexsurv</code> package. This dataset has death, or censoring
times for 686 primary node positive breast cancer patients together with
a 3-level prognostic group variable with levels “Good”, “Medium” and
“Poor”. For this demonstration we collapse the prognostic variable into
2 levels: “Good” and “Medium/Poor”. We also create some artificial ages
and diagnosis dates for the patients, along with assuming all patients
are female. We allow a correlation between the age at diagnosis for a
patient and their survival time so that age is a prognostic variable.
The mean age is 65 with a standard deviation of 5. We load this dataset
and create these additional variables.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/flexsurv" class="external-link">flexsurv</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jrdnmdhl/flexsurvcure" class="external-link">flexsurvcure</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html" class="external-link">survminer</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">236236</span><span class="op">)</span></span>
<span><span class="co">## Age at diagnosis is correlated with survival time. A longer survival time </span></span>
<span><span class="co">## gives a younger mean age</span></span>
<span><span class="va">bc</span><span class="op">$</span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, mean <span class="op">=</span> <span class="fl">65</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">bc</span><span class="op">$</span><span class="va">recyrs</span>, scale<span class="op">=</span><span class="cn">F</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">## Create age at diagnosis in days - used later for matching to expected rates</span></span>
<span><span class="va">bc</span><span class="op">$</span><span class="va">agedays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">bc</span><span class="op">$</span><span class="va">age</span> <span class="op">*</span> <span class="fl">365.25</span><span class="op">)</span></span>
<span><span class="co">## Create some random diagnosis dates between 01/01/1984 and 31/12/1989</span></span>
<span><span class="va">bc</span><span class="op">$</span><span class="va">diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"01/01/1984"</span>, <span class="st">"%d/%m/%Y"</span><span class="op">)</span>, </span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"31/12/1989"</span>, <span class="st">"%d/%m/%Y"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                   origin<span class="op">=</span><span class="st">"1970-01-01"</span><span class="op">)</span></span>
<span><span class="co">## Create sex (assume all are female)</span></span>
<span><span class="va">bc</span><span class="op">$</span><span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"female"</span><span class="op">)</span></span>
<span><span class="co">## 2-level prognostic variable</span></span>
<span><span class="va">bc</span><span class="op">$</span><span class="va">group2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">bc</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"Good"</span>, <span class="st">"Good"</span>, <span class="st">"Medium/Poor"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span></span>
<span><span class="co">#&gt;   censrec rectime group   recyrs      age agedays       diag    sex group2</span></span>
<span><span class="co">#&gt; 1       0    1342  Good 3.676712 64.38839   23517 1986-09-15 female   Good</span></span>
<span><span class="co">#&gt; 2       0    1578  Good 4.323288 67.31488   24586 1986-08-12 female   Good</span></span>
<span><span class="co">#&gt; 3       0    1760  Good 4.821918 61.77993   22565 1985-11-10 female   Good</span></span>
<span><span class="co">#&gt; 4       0    1152  Good 3.156164 65.20415   23815 1987-02-28 female   Good</span></span>
<span><span class="co">#&gt; 5       0     967  Good 2.649315 68.74975   25110 1986-05-18 female   Good</span></span>
<span><span class="co">#&gt; 6       0     629  Good 1.723288 64.53328   23570 1987-03-07 female   Good</span></span></code></pre></div>
<p>A plot of the Kaplan-Meier shows a clear separation in the survival
curves between the two prognostic groups.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">km</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">recyrs</span>, <span class="va">censrec</span><span class="op">)</span><span class="op">~</span><span class="va">group2</span>, data<span class="op">=</span><span class="va">bc</span><span class="op">)</span></span>
<span><span class="va">kmsurvplot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html" class="external-link">ggsurvplot</a></span><span class="op">(</span><span class="va">km</span><span class="op">)</span> </span>
<span><span class="va">kmsurvplot</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time from diagnosis (years)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="a-stratified-weibull-model">A stratified Weibull model<a class="anchor" aria-label="anchor" href="#a-stratified-weibull-model"></a>
</h3>
<p>We start by fitting a Weibull model to each group separately. One way
to do this is to fit a single saturated model whereby group affects both
the scale and shape parameters of the Weibull distribution. This
effectively means we have a separate scale and shape parameter for each
group, which is equivalent to fitting two separate models. Such a model
does not make a proportional hazards assumption and hence the hazard
ratio will change over time. The saturated model approach has advantages
as we can use the model to easily investigate treatment effects using
<code>standsurv</code> as we shall see later. Including group in the
main formula of <code>flexsurvreg</code> allows group to affect the
scale parameter of the Weibull distribution whilst we use the
<code>anc</code> argument in <code>flexsurvreg</code> to additionally
allow group to affect the shape parameter.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model.weibull.sep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flexsurvreg.html">flexsurvreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">recyrs</span>, <span class="va">censrec</span><span class="op">)</span><span class="op">~</span><span class="va">group2</span>, </span>
<span>                                 anc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="op">~</span> <span class="va">group2</span><span class="op">)</span>, </span>
<span>                                 data<span class="op">=</span><span class="va">bc</span>, dist<span class="op">=</span><span class="st">"weibullPH"</span><span class="op">)</span></span>
<span><span class="va">model.weibull.sep</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; flexsurvreg(formula = Surv(recyrs, censrec) ~ group2, anc = list(shape = ~group2), </span></span>
<span><span class="co">#&gt;     data = bc, dist = "weibullPH")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;                           data mean  est       L95%      U95%      se      </span></span>
<span><span class="co">#&gt; shape                           NA    1.68681   1.32989   2.13952   0.20461</span></span>
<span><span class="co">#&gt; scale                           NA    0.02187   0.01119   0.04274   0.00748</span></span>
<span><span class="co">#&gt; group2Medium/Poor          0.66618    1.84846   1.14534   2.55157   0.35874</span></span>
<span><span class="co">#&gt; shape(group2Medium/Poor)   0.66618   -0.28237  -0.54219  -0.02254   0.13257</span></span>
<span><span class="co">#&gt;                           exp(est)  L95%      U95%    </span></span>
<span><span class="co">#&gt; shape                           NA        NA        NA</span></span>
<span><span class="co">#&gt; scale                           NA        NA        NA</span></span>
<span><span class="co">#&gt; group2Medium/Poor          6.35001   3.14351  12.82725</span></span>
<span><span class="co">#&gt; shape(group2Medium/Poor)   0.75400   0.58147   0.97771</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 686,  Events: 299,  Censored: 387</span></span>
<span><span class="co">#&gt; Total time at risk: 2113.425</span></span>
<span><span class="co">#&gt; Log-likelihood = -830.4043, df = 4</span></span>
<span><span class="co">#&gt; AIC = 1668.809</span></span></code></pre></div>
<p>Given that the model only contains <code>group2</code> and no other
covariates we can obtain the predicted (fitted) survival for each of the
two groups using the <code>summary</code> function and storing these
predictions in a tidy data.frame with the argument
<code>tidy=T</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>, type <span class="op">=</span> <span class="st">"survival"</span>, tidy<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">est</span>, color <span class="op">=</span> <span class="va">group2</span><span class="op">)</span>, data<span class="op">=</span><span class="va">predictions</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">surv</span>, group<span class="op">=</span><span class="va">strata</span><span class="op">)</span>, data<span class="op">=</span><span class="va">kmsurvplot</span><span class="op">$</span><span class="va">data.survplot</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<p>The Weibull model does not appear to fit the data very well and so we
should try other parametric distributions. However, for illustration
purposes we shall continue using the Weibull model. We will now show
that the same predictions can be obtained from <code>standsurv</code>
but with the benefit of addition flexibility.</p>
</div>
<div class="section level3">
<h3 id="using-standsurv-to-calculate-marginal-survival">Using <code>standsurv</code> to calculate marginal survival<a class="anchor" aria-label="anchor" href="#using-standsurv-to-calculate-marginal-survival"></a>
</h3>
<p><code>standsurv</code> works similarly to the <code>margins</code>
command in <code>R</code> and <code>standsurv</code> in Stata by
allowing the user to specify a list of scenarios in which specific
covariates are fixed to certain values. This is done using the
<code>at</code> argument of <code>standsurv</code> to provide the list
of scenarios where each scenario is itself a list containing covariates
that are to be fixed. In our worked example the two scenarios are
<code>list(group2 = "Good")</code> and
<code>list(group2 = "Medium/Poor")</code>. Any covariates not specified
in the <code>at</code> scenarios are averaged over, hence creating
marginal, or standardized, estimates of the metric of interest. In the
example above, there are no other covariates in the model so we will get
the same answer as obtained from <code>summary</code>. But the later
worked example extends this to models containing other covariates. The
default is to calculate survival probabilities at the event times in the
data but this can be changed with the <code>type</code> and
<code>t</code> arguments, respectively. The returned object is a tidy
data.frame with columns named <code>at1</code> up to <code>atn</code>
for the n scenarios specified in the <code>at</code> argument.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss.weibull.sep.surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>,</span>
<span>                                             type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                             at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                       <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ss.weibull.sep.surv</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 574 × 3</span></span></span>
<span><span class="co">#&gt;      time   at1   at2</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0.021<span style="text-decoration: underline;">9</span> 1.00  0.999</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 0.041<span style="text-decoration: underline;">1</span> 1.00  0.998</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 0.043<span style="text-decoration: underline;">8</span> 1.00  0.997</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 0.046<span style="text-decoration: underline;">6</span> 1.00  0.997</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 0.049<span style="text-decoration: underline;">3</span> 1.00  0.997</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 0.079<span style="text-decoration: underline;">5</span> 1.00  0.994</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 0.115  0.999 0.991</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 0.126  0.999 0.990</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 0.156  0.999 0.987</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 0.173  0.999 0.985</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 564 more rows</span></span></span></code></pre></div>
<p>Further details such as labels for the <code>at</code> scenarios are
stored in attributes of the <code>standsurv</code> object. These are
utilised by the <code>plot</code> function. A plot of the marginal
estimates can be easily produced using the <code>plot</code> function,
which produces a <code>ggplot</code> object.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.surv</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
<p>The plot can be easily further manipulated, for example by changing
axis labels and adding further plots.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.surv</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time since diagnosis (years)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">surv</span>, group<span class="op">=</span><span class="va">strata</span><span class="op">)</span>, data<span class="op">=</span><span class="va">kmsurvplot</span><span class="op">$</span><span class="va">data.survplot</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-9-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="other-metrics-marginal-hazards-and-marginal-rmst">Other metrics: marginal hazards and marginal RMST<a class="anchor" aria-label="anchor" href="#other-metrics-marginal-hazards-and-marginal-rmst"></a>
</h3>
<p>We can use the <code>type</code> argument to calculate marginal
hazards or restricted mean survival time (RMST). For example a plot of
the hazard functions for the two groups is obtained as follows:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss.weibull.sep.haz</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>,</span>
<span>                                            type <span class="op">=</span> <span class="st">"hazard"</span>,</span>
<span>                                            at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.haz</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time since diagnosis (years)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-10-1.png" width="768"></p>
<p>Whilst a plot of RMST is given by</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss.weibull.sep.rmst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>,</span>
<span>                                             type <span class="op">=</span> <span class="st">"rmst"</span>,</span>
<span>                                             at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                       <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.rmst</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time since diagnosis (years)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-11-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="calculating-contrasts">Calculating contrasts<a class="anchor" aria-label="anchor" href="#calculating-contrasts"></a>
</h3>
<p>The advantage of fitting a saturated model now becomes clear as we
can calculate contrasts between our <code>at</code> scenarios. Suppose
we are interested in the difference in the survival functions between
the two groups. This is easily calculated using the
<code>contrast = "difference"</code> argument, and a plot of the
contrast can be obtained using <code>contrast = TRUE</code> argument in
the <code>plot</code> function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss.weibull.sep.3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>,</span>
<span>                                          type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                          contrast <span class="op">=</span> <span class="st">"difference"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.3</span>, contrast<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time since diagnosis (years)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Difference in survival probabilities"</span><span class="op">)</span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-12-1.png" width="768"></p>
<p>Alternatively, we may wish to visualise the implied hazard ratio from
fitting separate Weibull models to the two groups. In the breast cancer
example we see that the hazard ratio (treatment effect) starts very high
before decreasing, suggesting that those with Medium/Poor prognosis
start with a high elevated risk but have a continued excess risk up to
the end of follow-up, compared to those with Good prognosis.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss.weibull.sep.4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>,</span>
<span>                                          type <span class="op">=</span> <span class="st">"hazard"</span>,</span>
<span>                                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                          contrast <span class="op">=</span> <span class="st">"ratio"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.4</span>, contrast<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time since diagnosis (years)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard ratio"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-13-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="confidence-intervals-and-standard-errors">Confidence intervals and standard errors<a class="anchor" aria-label="anchor" href="#confidence-intervals-and-standard-errors"></a>
</h3>
<p>Confidence intervals and standard errors for both the metric of
interest and contrasts can be obtained either through bootstrapping or
using the delta method. Bootstrap confidence intervals are calculated by
specifying <code>ci = TRUE</code>, <code>boot = TRUE</code>, and
providing the number of bootstrap samples using <code>B</code>. We can
also set the seed using the <code>seed</code> argument to allow
reproducibility.</p>
<p>If instead the delta method is to be used to obtain confidence
intervals then we specify <code>ci = TRUE</code>,
<code>boot = FALSE</code>. The delta method obtains confidence intervals
by calculating standard errors for a given transformation of the metric
of interest and then assuming normality. The default is to use a log
transformation; hence if <code>type = "survival"</code> the confidence
intervals are symmetric for the log survival probabilities. Alternative
transformations can be specified using the <code>trans</code>
argument.</p>
<p>The code below shows confidence intervals for marginal survival
calculated through a bootstrap method (with <code>B = 100</code>)
compared to a delta method. For computational efficiency here we only
predict for 10 time points.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss.weibull.sep.boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>,</span>
<span>                                          type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                          t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span>,length<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                                          ci <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                          boot <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                          B <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                                          seed <span class="op">=</span> <span class="fl">2367</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calculating bootstrap standard errors / confidence intervals</span></span>
<span></span>
<span><span class="va">ss.weibull.sep.deltam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>,</span>
<span>                                          type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                          t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span>,length<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                                          ci <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                          boot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calculating standard errors / confidence intervals using delta method</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.boot</span>, ci <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, ymin<span class="op">=</span><span class="va">survival_lci</span>, ymax<span class="op">=</span><span class="va">survival_uci</span>, color<span class="op">=</span><span class="va">at</span>, linetype <span class="op">=</span> <span class="st">"Delta method"</span><span class="op">)</span>, fill<span class="op">=</span><span class="cn">NA</span>,</span>
<span>              data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">ss.weibull.sep.deltam</span>,<span class="st">"standpred_at"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Bootstrap"</span> <span class="op">=</span> <span class="st">"solid"</span>, <span class="st">"Delta method"</span><span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparison of bootstrap and delta method confidence intervals"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">linetype</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">linetype</span>, which will replace the existing scale.</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-14-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="adding-age-as-a-covariate">Adding age as a covariate<a class="anchor" aria-label="anchor" href="#adding-age-as-a-covariate"></a>
</h3>
<p>Suppose age has been added as a covariate to the survival model. If
age is not included in our <code>at</code> scenarios
<code>standsurv</code> will by default produce standardized estimates of
survival averaged over the age distribution in our study population.
Alternatively we could pass a new prediction dataset to
<code>standsurv</code> and obtain standardized estimates for this
population. As an example, we obtain marginal survival estimates after
fitting a stratified Weibull model, firstly standardized to the
age-distribution of our study population and secondly standardized to an
older population with mean age of 75 and standard deviation 5.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model.weibull.age.sep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flexsurvreg.html">flexsurvreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">recyrs</span>, <span class="va">censrec</span><span class="op">)</span><span class="op">~</span><span class="va">group2</span> <span class="op">+</span> <span class="va">age</span>, </span>
<span>                                 anc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="op">~</span> <span class="va">group2</span> <span class="op">+</span> <span class="va">age</span><span class="op">)</span>, </span>
<span>                                 data<span class="op">=</span><span class="va">bc</span>, dist<span class="op">=</span><span class="st">"weibullPH"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Marginal survival standardized to age distribution of study population</span></span>
<span><span class="va">ss.weibull.age.sep.surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.age.sep</span>,</span>
<span>                                             type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                             at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                       <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                             t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span>,length<span class="op">=</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Marginal survival standardized to an older population</span></span>
<span><span class="co"># create a new prediction dataset as a copy of the bc data but whose ages are drawn from</span></span>
<span><span class="co"># a normal distribution with mean age 75, sd 5.</span></span>
<span><span class="va">newpred.data</span> <span class="op">&lt;-</span> <span class="va">bc</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">247</span><span class="op">)</span></span>
<span><span class="va">newpred.data</span><span class="op">$</span><span class="va">age</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">75</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">ss.weibull.age2.sep.surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.age.sep</span>,</span>
<span>                                             type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                             at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                       <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                             t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span>,length<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>                                             newdata<span class="op">=</span><span class="va">newpred.data</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Overlay both marginal survival curves</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.age.sep.surv</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">survival</span>, color<span class="op">=</span><span class="va">at</span>, linetype <span class="op">=</span> <span class="st">"Older population"</span><span class="op">)</span>,</span>
<span>            data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">ss.weibull.age2.sep.surv</span>, <span class="st">"standpred_at"</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Study"</span> <span class="op">=</span> <span class="st">"solid"</span>, <span class="st">"Older population"</span><span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">linetype</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">linetype</span>, which will replace the existing scale.</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-15-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="calculating-expected-survival-and-hazard-in-standsurv">Calculating expected survival and hazard in
<code>standsurv</code><a class="anchor" aria-label="anchor" href="#calculating-expected-survival-and-hazard-in-standsurv"></a>
</h3>
<p>To overlay marginal expected survival or hazard curves we require a
lifetable of population hazard rates. To demonstrate we use the US
lifetable that comes with the <code>survival</code> package, called
<code>survexp.us</code>. Other lifetables can be obtained directly from
the Human Mortality Database (HMD) using the <code>HMDHFDplus</code>
package.</p>
<p>The <code>survexp.us</code> lifetable is a <code>ratetable</code>
object with stratification factors age, sex and year. It gives rates of
mortality per person-day for combinations of the stratification factors.
A summary of the <code>survexp.us</code> object shows that the
time-scale is in days.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">survexp.us</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Rate table with 3 dimensions:</span></span>
<span><span class="co">#&gt;  age ranges from 0 to 39812.25; with 110 categories</span></span>
<span><span class="co">#&gt;  sex has levels of: male female</span></span>
<span><span class="co">#&gt;  year ranges from 1940-01-01 to 2014-01-01; with 75 categories</span></span></code></pre></div>
<p>To use the lifetable to get expected rates for our trial population
we need to match age, sex and year variables in our dataset to those in
the ratetable. We can use the <code>rmap</code> argument to do this.
<code>standsurv</code> utilises the <code>survexp</code> function in the
<code>survival</code> package to calculate expected survival over the
times specified in <code>t</code> using the ‘exact’ method of Ederer. We
note that sex in our data is coded the same as in the
<code>ratetable</code> (“male” and “female”) and importantly that we
have variables that record both age at diagnosis and diagnosis date in
days. It is important that the user ensures that the study data are
correctly coded and have variables on the same timescale as in the
<code>ratetable</code> so that matching is successful. The code below
demonstrates that for our data we therefore need to match the
<code>year</code> variable in the <code>ratetable</code> to the
<code>diag</code> variable in our study data, and the <code>age</code>
variable in the <code>ratetable</code> to the <code>agedays</code>
variable in our study data.</p>
<p>We need to specify three more arguments in <code>standsurv</code>.
First, the lifetable, which must be a <code>ratetable</code> object and
is specified using the <code>ratetable</code> argument. Second, we may
need to pass our trial dataset to <code>standsurv</code> if the
stratifying factors do not appear as covariates in the
<code>flexsurv</code> model. Finally, we need to be careful to tell
<code>standsurv</code> what the time scale transformation is between the
fitted <code>flexsurv</code> model and the time scale in
<code>ratetable</code>. We can use the <code>scale.ratetable</code>
argument to do this. Typically ratetable objects are expressed in days
(e.g. rates per person-day). The default is therefore
<code>scale.ratetable = 365.25</code>, which indicates that the survival
model was fitted in years but the ratetable is in days.</p>
<p>After running <code>standsurv</code> we can plot the expected
survival (or hazard) by using the argument <code>expected = TRUE</code>
in the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> function.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss.weibull.sep.expected</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>,</span>
<span>                                                 type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                                 t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span>,length<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>                                                 rmap<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="va">sex</span>,</span>
<span>                                                           year <span class="op">=</span> <span class="va">diag</span>,</span>
<span>                                                           age <span class="op">=</span> <span class="va">agedays</span></span>
<span>                                                 <span class="op">)</span>,</span>
<span>                                                 ratetable <span class="op">=</span> <span class="va">survexp.us</span>,</span>
<span>                                                 scale.ratetable <span class="op">=</span> <span class="fl">365.25</span>,</span>
<span>                                                 newdata <span class="op">=</span> <span class="va">bc</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Calculating marginal expected survival and hazard</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.expected</span>, expected <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-17-1.png" width="768"></p>
<p>We can see that the marginal expected survival is much higher than
the marginal (predicted) survival for our breast cancer population. We
can also obtain the expected hazards:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss.weibull.sep.expectedh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep</span>,</span>
<span>                                                 type <span class="op">=</span> <span class="st">"hazard"</span>,</span>
<span>                                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                                 t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span>,length<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>                                                 rmap<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="va">sex</span>,</span>
<span>                                                           year <span class="op">=</span> <span class="va">diag</span>,</span>
<span>                                                           age <span class="op">=</span> <span class="va">agedays</span></span>
<span>                                                 <span class="op">)</span>,</span>
<span>                                                 ratetable <span class="op">=</span> <span class="va">survexp.us</span>,</span>
<span>                                                 scale.ratetable <span class="op">=</span> <span class="fl">365.25</span>,</span>
<span>                                                 newdata <span class="op">=</span> <span class="va">bc</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Calculating marginal expected survival and hazard</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.expectedh</span>, expected <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-18-1.png" width="768"></p>
<p>The hazard plot shows that our model is predicting an increasing
hazard over time for the cancer population, which remains significantly
higher than the expected hazard in the general population. The
monotonically increasing hazard imposed by the Weibull distribution may
be implausible and this may make us question the suitability of a
Weibull model if we wish to extrapolate.</p>
</div>
<div class="section level3">
<h3 id="incorporation-of-background-mortality">Incorporation of background mortality<a class="anchor" aria-label="anchor" href="#incorporation-of-background-mortality"></a>
</h3>
<p>A relative survival model can be fitted using <code>flexsurv</code>
by incorporating background mortality rates. The model then estimates
excess hazard rates and relative survival measures. For prediction
purposes, following the fitting of a relative survival model,
<code>standsurv</code> allows the user to either obtain marginal
predictions of relative survival / excess hazard or of all-cause
survival / all-cause hazard. The latter are calculated by multiplying
relative survival estimates with expected survival to get all-cause
survival, or by adding excess hazard rates to expected hazard to get
all-cause hazard.</p>
<p>We demonstrate this by fitting a relative survival cure model to the
breast cancer data and obtaining predicted all-cause survival and
all-cause hazard up to 30-years after diagnosis. A mixture cure model
makes the assumption that a proportion of the study population will
never experience the event. In a relative survival framework the cure
model assumes that the excess mortality rate approaches zero (or
equivalently the relative survival reaches an asymptote determined by
the cure fraction). We fit a relative survival cure model with a Weibull
distribution assumed for the uncured.</p>
<p>The relative survival mixture-cure model is fitted below. We must
pass to <code>flexsurvcure</code> the expected hazard rates at the event
/ censoring time for each individual, as it is the expected rates at the
event times that are used in the likelihood function for a parametric
relative survival model. For this we need to initally do some data
wrangling. Firstly, we calculate attained age and attained year (in
whole years) at the event time for all study subjects. Secondly, we join
the data with the expected rates using the matching variables attained
age, attained year and sex. In the example, we express the expected rate
as per person-year as this is the timescale used in the flexsurv
regression model.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## reshape US lifetable to be a tidy data.frame, and convert rates to per person-year as flexsurv regression is in years</span></span>
<span><span class="va">survexp.us.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">as.data.frame.table</a></span><span class="op">(</span><span class="va">survexp.us</span>, responseName <span class="op">=</span> <span class="st">"exprate"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>exprate <span class="op">=</span> <span class="fl">365.25</span> <span class="op">*</span> <span class="va">exprate</span><span class="op">)</span></span>
<span><span class="va">survexp.us.df</span><span class="op">$</span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">survexp.us.df</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">survexp.us.df</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">survexp.us.df</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Obtain attained age and attained calendar year in (whole) years</span></span>
<span><span class="va">bc</span> <span class="op">&lt;-</span> <span class="va">bc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>attained.age.yr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">age</span> <span class="op">+</span> <span class="va">recyrs</span><span class="op">)</span>,</span>
<span>                    attained.year <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">diag</span> <span class="op">+</span> <span class="va">rectime</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## merge in (left join) expected rates at event time</span></span>
<span><span class="va">bc</span> <span class="op">&lt;-</span> <span class="va">bc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">survexp.us.df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"attained.age.yr"</span><span class="op">=</span><span class="st">"age"</span>, </span>
<span>                                        <span class="st">"attained.year"</span><span class="op">=</span><span class="st">"year"</span>, </span>
<span>                                        <span class="st">"sex"</span><span class="op">=</span><span class="st">"sex"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># A stratified relative survival mixture-cure model</span></span>
<span><span class="va">model.weibull.sep.rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flexsurvcure/man/flexsurvcure.html" class="external-link">flexsurvcure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">recyrs</span>, <span class="va">censrec</span><span class="op">)</span><span class="op">~</span><span class="va">group2</span>, </span>
<span>                                 anc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="op">~</span> <span class="va">group2</span>,</span>
<span>                                            scale <span class="op">=</span> <span class="op">~</span> <span class="va">group2</span><span class="op">)</span>, </span>
<span>                                 data<span class="op">=</span><span class="va">bc</span>, dist<span class="op">=</span><span class="st">"weibullPH"</span>,</span>
<span>                                 bhazard<span class="op">=</span><span class="va">exprate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model.weibull.sep.rs</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; flexsurvcure(formula = Surv(recyrs, censrec) ~ group2, data = bc, </span></span>
<span><span class="co">#&gt;     bhazard = exprate, dist = "weibullPH", anc = list(shape = ~group2, </span></span>
<span><span class="co">#&gt;         scale = ~group2))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;                           data mean  est       L95%      U95%      se      </span></span>
<span><span class="co">#&gt; theta                           NA    0.73277   0.60988   0.82787        NA</span></span>
<span><span class="co">#&gt; shape                           NA    2.62590   1.88756   3.65306   0.44231</span></span>
<span><span class="co">#&gt; scale                           NA    0.02973   0.00993   0.08896   0.01663</span></span>
<span><span class="co">#&gt; group2Medium/Poor          0.66618   -1.76733  -2.48411  -1.05055   0.36571</span></span>
<span><span class="co">#&gt; shape(group2Medium/Poor)   0.66618   -0.52951  -0.88563  -0.17340   0.18170</span></span>
<span><span class="co">#&gt; scale(group2Medium/Poor)   0.66618    1.81159   0.68352   2.93965   0.57555</span></span>
<span><span class="co">#&gt;                           exp(est)  L95%      U95%    </span></span>
<span><span class="co">#&gt; theta                           NA        NA        NA</span></span>
<span><span class="co">#&gt; shape                           NA        NA        NA</span></span>
<span><span class="co">#&gt; scale                           NA        NA        NA</span></span>
<span><span class="co">#&gt; group2Medium/Poor          0.17079   0.08340   0.34974</span></span>
<span><span class="co">#&gt; shape(group2Medium/Poor)   0.58889   0.41245   0.84080</span></span>
<span><span class="co">#&gt; scale(group2Medium/Poor)   6.12014   1.98084  18.90922</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 686,  Events: 299,  Censored: 387</span></span>
<span><span class="co">#&gt; Total time at risk: 2113.425</span></span>
<span><span class="co">#&gt; Log-likelihood = -784.3236, df = 6</span></span>
<span><span class="co">#&gt; AIC = 1580.647</span></span></code></pre></div>
<p>We can now use <code>standsurv</code> to obtain all-cause survival
and hazard predictions using <code>type = "survival"</code> and
<code>type = "hazard"</code>. If instead we had wanted predictions of
relative survival or excess hazards we would use
<code>type = "relsurvival"</code> and
<code>type = "excesshazard"</code>, respectively.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## All-cause survival</span></span>
<span><span class="va">ss.weibull.sep.rs.surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep.rs</span>,</span>
<span>                                                 type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                                 t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">30</span>,length<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>                                                 rmap<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="va">sex</span>,</span>
<span>                                                           year <span class="op">=</span> <span class="va">diag</span>,</span>
<span>                                                           age <span class="op">=</span> <span class="va">agedays</span></span>
<span>                                                 <span class="op">)</span>,</span>
<span>                                                 ratetable <span class="op">=</span> <span class="va">survexp.us</span>,</span>
<span>                                                 scale.ratetable <span class="op">=</span> <span class="fl">365.25</span>,</span>
<span>                                                 newdata <span class="op">=</span> <span class="va">bc</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Marginal all-cause survival will be calculated</span></span>
<span><span class="co">#&gt; Calculating marginal expected survival and hazard</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.rs.surv</span>, expected <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-20-1.png" width="768"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># All-cause hazard</span></span>
<span><span class="va">ss.weibull.sep.rs.haz</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep.rs</span>,</span>
<span>                                                 type <span class="op">=</span> <span class="st">"hazard"</span>,</span>
<span>                                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                                 t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">30</span>,length<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>                                                 rmap<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="va">sex</span>,</span>
<span>                                                           year <span class="op">=</span> <span class="va">diag</span>,</span>
<span>                                                           age <span class="op">=</span> <span class="va">agedays</span></span>
<span>                                                 <span class="op">)</span>,</span>
<span>                                                 ratetable <span class="op">=</span> <span class="va">survexp.us</span>,</span>
<span>                                                 scale.ratetable <span class="op">=</span> <span class="fl">365.25</span>,</span>
<span>                                                 newdata <span class="op">=</span> <span class="va">bc</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Marginal all-cause hazard will be calculated</span></span>
<span><span class="co">#&gt; Calculating marginal expected survival and hazard</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.rs.haz</span>, expected <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-20-2.png" width="768"></p>
<p>The marginal excess hazard is now unimodal since the cure model is
forcing the initially increasing excess hazard to tend to zero in the
long-term where only ‘cured’ subjects remain. The marginal all-cause
hazard tends to the expected hazard and follows it thereafter.</p>
<p>A plot of the excess hazard confirms this.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Excess hazard</span></span>
<span><span class="va">ss.weibull.sep.rs.excesshaz</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standsurv.html">standsurv</a></span><span class="op">(</span><span class="va">model.weibull.sep.rs</span>,</span>
<span>                                                 type <span class="op">=</span> <span class="st">"excesshazard"</span>,</span>
<span>                                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Good"</span><span class="op">)</span>,</span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group2 <span class="op">=</span> <span class="st">"Medium/Poor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                                 t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">30</span>,length<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>                                                 rmap<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="va">sex</span>,</span>
<span>                                                           year <span class="op">=</span> <span class="va">diag</span>,</span>
<span>                                                           age <span class="op">=</span> <span class="va">agedays</span></span>
<span>                                                 <span class="op">)</span>,</span>
<span>                                                 ratetable <span class="op">=</span> <span class="va">survexp.us</span>,</span>
<span>                                                 scale.ratetable <span class="op">=</span> <span class="fl">365.25</span>,</span>
<span>                                                 newdata <span class="op">=</span> <span class="va">bc</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Calculating marginal expected survival and hazard</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ss.weibull.sep.rs.excesshaz</span><span class="op">)</span></span></code></pre></div>
<p><img src="standsurv_files/figure-html/unnamed-chunk-21-1.png" width="768"></p>
</div>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p><code>standsurv</code> is a powerful post-estimation command that
allows easy calculation of a number of useful prediction metrics.
Contrasts can be made between any counterfactual populations of interest
and, through regression standardisation, allows the targeting of
marginal estimands. Confidence intervals, via the delta method or
bootstrapping, are available and benchmarking against or incorporating
background mortality rates is also supported.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-ederer_relative_1961" class="csl-entry">
Ederer, F., L. M. Axtell, and S. J. Cutler. 1961. <span>“The Relative
Survival Rate: A Statistical Methodology.”</span> <em>National Cancer
Institute Monograph</em> 6 (September): 101–21.
</div>
<div id="ref-rutherford_nice_2020" class="csl-entry">
Rutherford, Mark J, Paul C Lambert, Michael J Sweeting, Becky
Pennington, Michael J Crowther, Keith R Abrams, and Nicholas R. Latimer.
2020. <span>“<span>NICE</span> <span>DSU</span> <span>Technical</span>
<span>Support</span> <span>Document</span> 21: <span>Flexible</span>
Methods for Survival Analysis.”</span>
</div>
<div id="ref-syriopoulou_inverse_2021" class="csl-entry">
Syriopoulou, Elisavet, Mark J. Rutherford, and Paul C. Lambert. 2021.
<span>“Inverse Probability Weighting and Doubly Robust Standardization
in the Relative Survival Framework.”</span> <em>Statistics in
Medicine</em> 40 (27): 6069–92. <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.9171" class="external-link">https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.9171</a>.
</div>
<div id="ref-therneau_1999" class="csl-entry">
Therneau, Terry M. 1999. <span>“A Package for Survival Analysis in
<span>S</span>.”</span> <a href="https://www.mayo.edu/research/documents/tr53pdf/doc-10027379" class="external-link">https://www.mayo.edu/research/documents/tr53pdf/doc-10027379</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
