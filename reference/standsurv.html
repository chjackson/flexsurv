<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Returns a tidy data.frame of marginal survival probabilities, or hazards, 
restricted mean survival, or quantiles of the marginal survival function
at user-defined time points and covariate patterns.
Standardization is performed over any undefined covariates in the model. 
The user provides the data to standardize over. Contrasts can be calculated 
resulting in estimates of the average treatment effect or the average 
treatment effect in the treated if a treated subset of the data are supplied."><title>Marginal survival and hazards of fitted flexsurvreg models — standsurv • flexsurv</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Marginal survival and hazards of fitted flexsurvreg models — standsurv"><meta property="og:description" content="Returns a tidy data.frame of marginal survival probabilities, or hazards, 
restricted mean survival, or quantiles of the marginal survival function
at user-defined time points and covariate patterns.
Standardization is performed over any undefined covariates in the model. 
The user provides the data to standardize over. Contrasts can be calculated 
resulting in estimates of the average treatment effect or the average 
treatment effect in the treated if a treated subset of the data are supplied."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">flexsurv</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/pdf.html">flexsurv PDF vignettes</a>
    <a class="dropdown-item" href="../articles/standsurv.html">Calculating standardized survival measures in flexsurv</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/flexsurv/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Marginal survival and hazards of fitted flexsurvreg models</h1>
      <small class="dont-index">Source: <a href="https://github.com/chjackson/flexsurv/blob/HEAD/R/standsurv.R" class="external-link"><code>R/standsurv.R</code></a></small>
      <div class="d-none name"><code>standsurv.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Returns a tidy data.frame of marginal survival probabilities, or hazards, 
restricted mean survival, or quantiles of the marginal survival function
at user-defined time points and covariate patterns.
Standardization is performed over any undefined covariates in the model. 
The user provides the data to standardize over. Contrasts can be calculated 
resulting in estimates of the average treatment effect or the average 
treatment effect in the treated if a treated subset of the data are supplied.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">standsurv</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  newdata <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  atreference <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>  t <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ci <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  se <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  boot <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  B <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  cl <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  trans <span class="op">=</span> <span class="st">"log"</span>,</span>
<span>  contrast <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  trans.contrast <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">rmap</span>,</span>
<span>  <span class="va">ratetable</span>,</span>
<span>  scale.ratetable <span class="op">=</span> <span class="fl">365.25</span>,</span>
<span>  n.gauss.quad <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  quantiles <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-08</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>object</dt>
<dd><p>Output from <code><a href="flexsurvreg.html">flexsurvreg</a></code> or
<code><a href="flexsurvspline.html">flexsurvspline</a></code>, representing a fitted survival model object.</p></dd>


<dt>newdata</dt>
<dd><p>Data frame containing covariate values to produce marginal
values for. If not specified then the fitted model data.frame is used.
There must be a column for every covariate in the model formula
for which the user wishes to standardize over.  These are in the same format
as the original data, with factors as a single variable, not 0/1 contrasts.
Any covariates that are to be fixed should be specified in <code>at</code>. 
There should be one row for every combination of covariates in which to 
standardize over. If newdata contains a variable named '(weights)' then a 
weighted mean will be used to create the standardized estimates. This is the
default behaviour if the fitted model contains case weights, which are stored 
in the fitted model data.frame.</p></dd>


<dt>at</dt>
<dd><p>A list of scenarios in which specific covariates are fixed to 
certain values. Each element of <code>at</code> must itself be a list. For example,
for a covariate <code>group</code> with levels "Good", "Medium" and "Poor", the 
standardized survival plots for each group averaging over all other 
covariates is specified using 
<code>at=list(list(group="Good"), list(group="Medium"), list(group="Poor"))</code>.</p></dd>


<dt>atreference</dt>
<dd><p>The reference scenario for making contrasts. Default is 1
(i.e. the first element of <code>at</code>).</p></dd>


<dt>type</dt>
<dd><p><code>"survival"</code> for marginal survival probabilities. In a 
relative survival framework this returns the marginal all-cause survival 
(see details).</p>
<p><code>"hazard"</code> for the hazard of the marginal survival probability. In a 
relative survival framework this returns the marginal all-cause hazard 
(see details).</p>
<p><code>"rmst"</code> for standardized restricted mean survival.</p>
<p><code>"relsurvival"</code> for marginal relative survival (can only be specified
if a relative survival model has been fitted in flexsurv).</p>
<p><code>"excesshazard"</code> for marginal excess hazards (can only be specified
if a relative survival model has been fitted in flexsurv).</p>
<p><code>"quantile"</code> for quantiles of the marginal all-cause survival 
distribution. The <code>quantiles</code> option also needs to be provided.</p></dd>


<dt>t</dt>
<dd><p>Times to calculate marginal values at.</p></dd>


<dt>ci</dt>
<dd><p>Should confidence intervals be calculated? 
Defaults to FALSE</p></dd>


<dt>se</dt>
<dd><p>Should standard errors be calculated? 
Defaults to FALSE</p></dd>


<dt>boot</dt>
<dd><p>Should bootstrapping be used to calculate standard error and 
confidence intervals? Defaults to FALSE, in which case the delta method is 
used</p></dd>


<dt>B</dt>
<dd><p>Number of bootstrap simulations from the normal asymptotic 
distribution of the estimates used to calculate confidence intervals or 
standard errors. Decrease for greater speed at the expense of accuracy. Only 
specify if <code>boot = TRUE</code></p></dd>


<dt>cl</dt>
<dd><p>Width of symmetric confidence intervals, relative to 1.</p></dd>


<dt>trans</dt>
<dd><p>Transformation to apply when calculating standard errors via the
delta method to obtain confidence intervals. The default transformation is 
"log". Other possible names are "none", "loglog", "logit".</p></dd>


<dt>contrast</dt>
<dd><p>Contrasts between standardized measures defined by <code>at</code>
scenarios. Options are <code>"difference"</code> and <code>"ratio"</code>. There will be
n-1 new columns created where n is the number of <code>at</code> scenarios. Default
is NULL (i.e. no contrasts are calculated).</p></dd>


<dt>trans.contrast</dt>
<dd><p>Transformation to apply when calculating standard errors
for contrasts via the delta method to obtain confidence intervals. The default
transformation is "none" for differences in survival, hazard, quantiles, or RMST, 
and "log" for ratios of survival, hazard, quantiles or RMST.</p></dd>


<dt>seed</dt>
<dd><p>The random seed to use (for bootstrapping confidence intervals)</p></dd>


<dt>rmap</dt>
<dd><p>An list that maps data set names to expected ratetable names. 
This must be specified if all-cause survival and hazards are required after
fitting a relative survival model. This can also be specified if expected
rates are required for plotting purposes. See the details section below.</p></dd>


<dt>ratetable</dt>
<dd><p>A table of expected event rates 
(see <code><a href="https://rdrr.io/pkg/survival/man/ratetable.html" class="external-link">ratetable</a></code>)</p></dd>


<dt>scale.ratetable</dt>
<dd><p>Transformation from the time scale of the fitted 
flexsurv model to the time scale in <code>ratetable</code>. For example, if the 
analysis time of the fitted model is in years and the ratetable is in 
units/day then we should use <code>scale.ratetable = 365.25</code>. This is the 
default as often the ratetable will be in units/day (see example).</p></dd>


<dt>n.gauss.quad</dt>
<dd><p>Number of Gaussian quadrature points used for integrating 
the all-cause survival function when calculating RMST in a relative survival 
framework (default = 100)</p></dd>


<dt>quantiles</dt>
<dd><p>If <code>type="quantile"</code>, this specifies the quantiles of 
the survival time distribution to return estimates for.</p></dd>


<dt>interval</dt>
<dd><p>Interval of survival times for quantile root finding. 
Default is c(1e-08, 500).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A <code>tibble</code> containing one row for each 
time-point. The column naming convention is <code>at{i}</code> for the ith scenario
with corresponding confidence intervals (if specified) named <code>at{i}_lci</code></p>


<p>and <code>at{i}_uci</code>. Contrasts are named <code>contrast{k}_{j}</code> for the 
comparison of the kth versus the jth <code>at</code> scenario.</p>


<p>In addition tidy long-format data.frames are returned in the attributes
<code>standsurv_at</code> and <code>standsurv_contrast</code>. These can be passed to 
<code>ggplot</code> for plotting purposes (see <code><a href="plot.standsurv.html">plot.standsurv</a></code>).</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The syntax of <code>standsurv</code> follows closely that of Stata's 
<code>standsurv</code> command written by Paul Lambert and Michael Crowther. The 
function calculates standardized (marginal) measures including standardized
survival functions, standardized restricted mean survival times, quantiles
and the hazard of standardized survival. The standardized survival is defined as
$$S_s(t|X=x) = E(S(t|X=x,Z)) = \frac{1}{N} \sum_{i=1}^N S(t|X=x,Z=z_i)$$
The hazard of the standardized survival is a weighted average of 
individual hazard functions at time t, weighted by the survival
function at this time:
$$h_s(t|X=x) = \frac{\sum_{i=1}^N S(t|X=x,Z=z_i)h(t|X=x,Z=z_i)}{\sum_{i=1}^N S(t|X=x,Z=z_i)}$$
Marginal expected survival and hazards can be calculated by providing a 
population-based lifetable of class ratetable in <code>ratetable</code> and a 
mapping between stratification factors in the lifetable and the user dataset
using <code>rmap</code>. If these stratification factors are not in the fitted
survival model then the user must specify them in <code>newdata</code> along with
the covariates of the model. The marginal expected survival is calculated 
using the "Ederer" method that assumes no censoring as this is most relevant 
approach for forecasting (see 
<code><a href="https://rdrr.io/pkg/survival/man/survexp.html" class="external-link">survexp</a></code>). A worked example is given below.</p>
<p>Marginal all-cause survival and hazards can be calculated after fitting a
relative survival model, which utilise the expected survival from a population
ratetable. See Rutherford et al. (Chapter 6) for further details.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Paul Lambert, 2021. "STANDSURV: Stata module to compute 
standardized (marginal) survival and related functions," 
Statistical Software Components S458991, Boston College Department of 
Economics. https://ideas.repec.org/c/boc/bocode/s458991.html</p>
<p>Rutherford, MJ, Lambert PC, Sweeting MJ, Pennington B, Crowther MJ, Abrams KR,
Latimer NR. 2020. "NICE DSU Technical Support Document 21: Flexible Methods 
for Survival Analysis" 
https://nicedsu.sites.sheffield.ac.uk/tsds/flexible-methods-for-survival-analysis-tsd</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Michael Sweeting &lt;mikesweeting79@gmail.com&gt;</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## mean age is higher in those with smaller observed survival times </span></span></span>
<span class="r-in"><span><span class="va">newbc</span> <span class="op">&lt;-</span> <span class="va">bc</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">newbc</span><span class="op">$</span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, mean <span class="op">=</span> <span class="fl">65</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">newbc</span><span class="op">$</span><span class="va">recyrs</span>, scale<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span> sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Fit a Weibull flexsurv model with group and age as covariates</span></span></span>
<span class="r-in"><span><span class="va">weib_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="flexsurvreg.html">flexsurvreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">recyrs</span>, <span class="va">censrec</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span><span class="op">+</span><span class="va">age</span>, data<span class="op">=</span><span class="va">newbc</span>, </span></span>
<span class="r-in"><span>                       dist<span class="op">=</span><span class="st">"weibull"</span><span class="op">)</span></span></span>
<span class="r-in"><span>                       </span></span>
<span class="r-in"><span><span class="co">## Calculate standardized survival and the difference in standardized survival</span></span></span>
<span class="r-in"><span><span class="co">## for the three levels of group across a grid of survival times                        </span></span></span>
<span class="r-in"><span><span class="va">standsurv_weib_age</span> <span class="op">&lt;-</span> <span class="fu">standsurv</span><span class="op">(</span><span class="va">weib_age</span>, </span></span>
<span class="r-in"><span>                                           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"Good"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                                                     <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"Medium"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                                                     <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"Poor"</span><span class="op">)</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                                           t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span>, length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                                           contrast <span class="op">=</span> <span class="st">"difference"</span>, ci<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">standsurv_weib_age</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 100 × 6</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      time   at1   at2   at3 contrast2_1 contrast3_1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 1</span> 0      1     1     1         0           0      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 2</span> 0.070<span style="text-decoration: underline;">7</span> 0.999 0.998 0.996    -<span style="color: #BB0000;">0.001</span><span style="color: #BB0000; text-decoration: underline;">11</span>    -<span style="color: #BB0000;">0.003</span><span style="color: #BB0000; text-decoration: underline;">53</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 3</span> 0.141  0.998 0.995 0.988    -<span style="color: #BB0000;">0.002</span><span style="color: #BB0000; text-decoration: underline;">93</span>    -<span style="color: #BB0000;">0.009</span><span style="color: #BB0000; text-decoration: underline;">31</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 4</span> 0.212  0.996 0.991 0.980    -<span style="color: #BB0000;">0.005</span><span style="color: #BB0000; text-decoration: underline;">17</span>    -<span style="color: #BB0000;">0.016</span><span style="color: #BB0000; text-decoration: underline;">4</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 5</span> 0.283  0.994 0.986 0.970    -<span style="color: #BB0000;">0.007</span><span style="color: #BB0000; text-decoration: underline;">72</span>    -<span style="color: #BB0000;">0.024</span><span style="color: #BB0000; text-decoration: underline;">4</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 6</span> 0.354  0.992 0.981 0.959    -<span style="color: #BB0000;">0.010</span><span style="color: #BB0000; text-decoration: underline;">5</span>     -<span style="color: #BB0000;">0.033</span><span style="color: #BB0000; text-decoration: underline;">1</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 7</span> 0.424  0.989 0.976 0.947    -<span style="color: #BB0000;">0.013</span><span style="color: #BB0000; text-decoration: underline;">5</span>     -<span style="color: #BB0000;">0.042</span><span style="color: #BB0000; text-decoration: underline;">5</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 8</span> 0.495  0.987 0.970 0.935    -<span style="color: #BB0000;">0.016</span><span style="color: #BB0000; text-decoration: underline;">7</span>     -<span style="color: #BB0000;">0.052</span><span style="color: #BB0000; text-decoration: underline;">3</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 9</span> 0.566  0.984 0.964 0.922    -<span style="color: #BB0000;">0.020</span><span style="color: #BB0000; text-decoration: underline;">1</span>     -<span style="color: #BB0000;">0.062</span><span style="color: #BB0000; text-decoration: underline;">6</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">10</span> 0.636  0.981 0.958 0.908    -<span style="color: #BB0000;">0.023</span><span style="color: #BB0000; text-decoration: underline;">6</span>     -<span style="color: #BB0000;">0.073</span><span style="color: #BB0000; text-decoration: underline;">2</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># ℹ 90 more rows</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Calculate hazard of standardized survival and the marginal hazard ratio</span></span></span>
<span class="r-in"><span><span class="co">## for the three levels of group across a grid of survival times</span></span></span>
<span class="r-in"><span><span class="co">## 10 bootstraps for confidence intervals (this should be larger)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>          </span></span>
<span class="r-in"><span><span class="va">haz_standsurv_weib_age</span> <span class="op">&lt;-</span> <span class="fu">standsurv</span><span class="op">(</span><span class="va">weib_age</span>, </span></span>
<span class="r-in"><span>                                           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"Good"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                                                     <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"Medium"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                                                     <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"Poor"</span><span class="op">)</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                                           t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span>, length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                                           type<span class="op">=</span><span class="st">"hazard"</span>,</span></span>
<span class="r-in"><span>                                           contrast <span class="op">=</span> <span class="st">"ratio"</span>, boot <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>                                           B<span class="op">=</span><span class="fl">10</span>, ci<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">haz_standsurv_weib_age</span>                                            </span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">haz_standsurv_weib_age</span>, ci<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## Hazard ratio plot shows a decreasing marginal HR </span></span></span>
<span class="r-in"><span><span class="co">## Whereas the conditional HR is constant (model is a PH model)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">haz_standsurv_weib_age</span>, contrast<span class="op">=</span><span class="cn">TRUE</span>, ci<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Calculate standardized survival from a Weibull model together with expected</span></span></span>
<span class="r-in"><span><span class="co">## survival matching to US lifetables</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># age at diagnosis in days. This is required to match to US ratetable, whose</span></span></span>
<span class="r-in"><span><span class="co"># timescale is measured in days</span></span></span>
<span class="r-in"><span><span class="va">newbc</span><span class="op">$</span><span class="va">agedays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">newbc</span><span class="op">$</span><span class="va">age</span> <span class="op">*</span> <span class="fl">365.25</span><span class="op">)</span>  </span></span>
<span class="r-in"><span><span class="co">## Create some random diagnosis dates centred on 01/01/2010 with SD=1 year</span></span></span>
<span class="r-in"><span><span class="co">## These will be used to match to expected rates in the lifetable</span></span></span>
<span class="r-in"><span><span class="va">newbc</span><span class="op">$</span><span class="va">diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">newbc</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span></span>
<span class="r-in"><span>                     mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"01/01/2010"</span>, <span class="st">"%d/%m/%Y"</span><span class="op">)</span>, sd<span class="op">=</span><span class="fl">365</span><span class="op">)</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                     origin<span class="op">=</span><span class="st">"1970-01-01"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## Create sex (assume all are female)</span></span></span>
<span class="r-in"><span><span class="va">newbc</span><span class="op">$</span><span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"female"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">standsurv_weib_expected</span> <span class="op">&lt;-</span> <span class="fu">standsurv</span><span class="op">(</span><span class="va">weib_age</span>, </span></span>
<span class="r-in"><span>                                           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"Good"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                                                     <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"Medium"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                                                     <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"Poor"</span><span class="op">)</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                                           t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span>, length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                                           rmap<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="va">sex</span>,</span></span>
<span class="r-in"><span>                                                     year <span class="op">=</span> <span class="va">diag</span>,</span></span>
<span class="r-in"><span>                                                     age <span class="op">=</span> <span class="va">agedays</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                                           ratetable <span class="op">=</span> <span class="fu">survival</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survival/man/survexp.us.html" class="external-link">survexp.us</a></span>,</span></span>
<span class="r-in"><span>                                           scale.ratetable <span class="op">=</span> <span class="fl">365.25</span>,</span></span>
<span class="r-in"><span>                                           newdata <span class="op">=</span> <span class="va">newbc</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## Plot marginal survival with expected survival superimposed                                            </span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">standsurv_weib_expected</span>, expected<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer></div>

  

  

  </body></html>

