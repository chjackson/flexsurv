<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="The matrix whose \(r,s\) entry is the expected amount of time spent in
state \(s\) for a time-inhomogeneous, continuous-time Markov multi-state
process that starts in state \(r\), up to a maximum time \(t\). This is
defined as the integral of the corresponding transition probability up to
that time."><title>Total length of stay in particular states for a fully-parametric, time-inhomogeneous Markov multi-state model — totlos.fs • flexsurv</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Total length of stay in particular states for a fully-parametric, time-inhomogeneous Markov multi-state model — totlos.fs"><meta property="og:description" content="The matrix whose \(r,s\) entry is the expected amount of time spent in
state \(s\) for a time-inhomogeneous, continuous-time Markov multi-state
process that starts in state \(r\), up to a maximum time \(t\). This is
defined as the integral of the corresponding transition probability up to
that time."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">flexsurv</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/pdf.html">flexsurv PDF vignettes</a>
    <a class="dropdown-item" href="../articles/standsurv.html">Calculating standardized survival measures in flexsurv</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/flexsurv/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Total length of stay in particular states for a fully-parametric, time-inhomogeneous Markov multi-state model</h1>
      <small class="dont-index">Source: <a href="https://github.com/chjackson/flexsurv/blob/HEAD/R/mstate.R" class="external-link"><code>R/mstate.R</code></a></small>
      <div class="d-none name"><code>totlos.fs.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>The matrix whose \(r,s\) entry is the expected amount of time spent in
state \(s\) for a time-inhomogeneous, continuous-time Markov multi-state
process that starts in state \(r\), up to a maximum time \(t\). This is
defined as the integral of the corresponding transition probability up to
that time.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">totlos.fs</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  trans <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  t <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  newdata <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ci <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  tvar <span class="op">=</span> <span class="st">"trans"</span>,</span>
<span>  sing.inf <span class="op">=</span> <span class="fl">1e+10</span>,</span>
<span>  B <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  cl <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>x</dt>
<dd><p>A model fitted with <code><a href="flexsurvreg.html">flexsurvreg</a></code>.  See
<code><a href="msfit.flexsurvreg.html">msfit.flexsurvreg</a></code> for the required form of the model and the
data.  Additionally, this must be a Markov / clock-forward model, but can
be time-inhomogeneous.  See the package vignette for further explanation.</p>
<p><code>x</code> can also be a list of models, with one component for each
permitted transition, as illustrated in <code><a href="msfit.flexsurvreg.html">msfit.flexsurvreg</a></code>.</p></dd>


<dt>trans</dt>
<dd><p>Matrix indicating allowed transitions.  See
<code><a href="msfit.flexsurvreg.html">msfit.flexsurvreg</a></code>.</p></dd>


<dt>t</dt>
<dd><p>Time or vector of times to predict up to.  Must be finite.</p></dd>


<dt>newdata</dt>
<dd><p>A data frame specifying the values of covariates in the
fitted model, other than the transition number.  See
<code><a href="msfit.flexsurvreg.html">msfit.flexsurvreg</a></code>.</p></dd>


<dt>ci</dt>
<dd><p>Return a confidence interval calculated by simulating from the
asymptotic normal distribution of the maximum likelihood estimates.  Turned
off by default, since this is computationally intensive.  If turned on,
users should increase <code>B</code> until the results reach the desired
precision.</p></dd>


<dt>tvar</dt>
<dd><p>Variable in the data representing the transition type. Not
required if <code>x</code> is a list of models.</p></dd>


<dt>sing.inf</dt>
<dd><p>If there is a singularity in the observed hazard, for
example a Weibull distribution with <code>shape &lt; 1</code> has infinite hazard at
<code>t=0</code>, then as a workaround, the hazard is assumed to be a large
finite number, <code>sing.inf</code>, at this time.  The results should not be
sensitive to the exact value assumed, but users should make sure by
adjusting this parameter in these cases.</p></dd>


<dt>B</dt>
<dd><p>Number of simulations from the normal asymptotic distribution used
to calculate variances.  Decrease for greater speed at the expense of
accuracy.</p></dd>


<dt>cl</dt>
<dd><p>Width of symmetric confidence intervals, relative to 1.</p></dd>


<dt>...</dt>
<dd><p>Arguments passed to <code>ode</code> in <span class="pkg">deSolve</span>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>The matrix of lengths of stay \(T(t)\), if <code>t</code> is of length
1, or a list of matrices if <code>t</code> is longer.</p>


<p>If <code>ci=TRUE</code>, each element has attributes <code>"lower"</code> and
<code>"upper"</code> giving matrices of the corresponding confidence limits.
These are formatted for printing but may be extracted using <code><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr()</a></code>.</p>


<p>The result also has an attribute <code>P</code> giving the transition probability
matrices, since these are unavoidably computed as a side effect.  These are
suppressed for printing, but can be extracted with <code>attr(...,"P")</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This is computed by solving a second order extension of the Kolmogorov
forward differential equation numerically, using the methods in the
<code>deSolve</code> package.  The equation is expressed as a linear
system</p>
<p>$$\frac{dT(t)}{dt} = P(t)$$ $$\frac{dP(t)}{dt} = P(t) Q(t)$$</p>
<p>and solved for \(T(t)\) and \(P(t)\) simultaneously, where \(T(t)\)
is the matrix of total lengths of stay, \(P(t)\) is the transition
probability matrix for time \(t\), and \(Q(t)\) is the transition
hazard or intensity as a function of \(t\).  The initial conditions are
\(T(0) = 0\) and \(P(0) = I\).</p>
<p>Note that the package <span class="pkg">msm</span> has a similar method <code>totlos.msm</code>.
<code>totlos.fs</code> should give the same results as <code>totlos.msm</code> when
both of these conditions hold:</p>
<ul><li><p>the time-to-event distribution is exponential for all
transitions, thus the <code>flexsurvreg</code> model was fitted with
<code>dist="exp"</code>, and is time-homogeneous.</p></li>
<li><p>the <span class="pkg">msm</span> model was
fitted with <code>exacttimes=TRUE</code>, thus all the event times are known, and
there are no time-dependent covariates.</p></li>
</ul><p><span class="pkg">msm</span> only allows exponential or piecewise-exponential time-to-event
distributions, while <span class="pkg">flexsurvreg</span> allows more flexible models.
<span class="pkg">msm</span> however was designed in particular for panel data, where the
process is observed only at arbitrary times, thus the times of transition
are unknown, which makes flexible models difficult.</p>
<p>This function is only valid for Markov ("clock-forward") multi-state
models, though no warning or error is currently given if the model is not
Markov.  See <code><a href="totlos.simfs.html">totlos.simfs</a></code> for the equivalent for semi-Markov
("clock-reset") models.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="totlos.simfs.html">totlos.simfs</a></code>, <code><a href="pmatrix.fs.html">pmatrix.fs</a></code>,
<code><a href="msfit.flexsurvreg.html">msfit.flexsurvreg</a></code>.</p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Christopher Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk">chris.jackson@mrc-bsu.cam.ac.uk</a>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># BOS example in vignette, and in msfit.flexsurvreg</span></span></span>
<span class="r-in"><span><span class="va">bexp</span> <span class="op">&lt;-</span> <span class="fu"><a href="flexsurvreg.html">flexsurvreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Tstart</span>, <span class="va">Tstop</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">trans</span>,</span></span>
<span class="r-in"><span>                    data<span class="op">=</span><span class="va">bosms3</span>, dist<span class="op">=</span><span class="st">"exp"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">tmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span>,<span class="fl">3</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># predict 4 years spent without BOS, 3 years with BOS, before death</span></span></span>
<span class="r-in"><span><span class="co"># As t increases, this should converge</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">totlos.fs</span><span class="op">(</span><span class="va">bexp</span>, t<span class="op">=</span><span class="fl">10</span>, trans<span class="op">=</span><span class="va">tmat</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,1]     [,2]      [,3]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 3.749105 2.126570  4.124326</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,] 0.000000 3.518329  6.481671</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,] 0.000000 0.000000 10.000000</span>
<span class="r-in"><span><span class="fu">totlos.fs</span><span class="op">(</span><span class="va">bexp</span>, t<span class="op">=</span><span class="fl">1000</span>, trans<span class="op">=</span><span class="va">tmat</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,1]     [,2]      [,3]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 4.109742 2.956493  992.9338</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,] 0.000000 3.788904  996.2111</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,] 0.000000 0.000000 1000.0000</span>
<span class="r-in"><span><span class="fu">totlos.fs</span><span class="op">(</span><span class="va">bexp</span>, t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span>, trans<span class="op">=</span><span class="va">tmat</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`5`</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,1]     [,2]     [,3]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 2.892316 1.068225 1.039459</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,] 0.000000 2.776392 2.223608</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,] 0.000000 0.000000 5.000000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`10`</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,1]     [,2]      [,3]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 3.749105 2.126570  4.124326</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,] 0.000000 3.518329  6.481671</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,] 0.000000 0.000000 10.000000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Answers should match results in help(totlos.simfs) up to Monte Carlo</span></span></span>
<span class="r-in"><span><span class="co"># error there / ODE solving precision here, since with an exponential</span></span></span>
<span class="r-in"><span><span class="co"># distribution, the "semi-Markov" model there is the same as the Markov</span></span></span>
<span class="r-in"><span><span class="co"># model here</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer></div>

  

  

  </body></html>

